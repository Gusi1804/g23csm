<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pagos Graduación Admin</title>

    <!-- Required meta tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- update the version number as needed -->
    <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-app-compat.js"></script>
    <!-- include only the Firebase features as you need -->
    <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.8.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://use.typekit.net/wuv7lww.css">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            // https://dashboard.emailjs.com/admin/account
            emailjs.init('0lB__J0umMpoXi8LV');
        })();
    </script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCM3RGa8Zl59QCsKtcmhBkPK7H1JL_LeUQ",
            authDomain: "g23-csm.firebaseapp.com",
            projectId: "g23-csm",
            storageBucket: "g23-csm.appspot.com",
            messagingSenderId: "735574331856",
            appId: "1:735574331856:web:6f826790f622f2c57869d5"
        };

        // Initialize Firebase
        const firebaseApp = firebase.initializeApp(firebaseConfig);
    </script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">

    <style>
        h1 {
            font-family: pt-serif-pro,sans-serif;
            font-weight: 600;
            font-style: normal;
        }

        h2 {
            font-family: pt-serif-pro,sans-serif;
            font-weight: 600;
            font-style: normal;
        }

        table {
            font-family: pt-serif-pro,sans-serif;
            font-weight: 400;
            font-style: normal;
        }

        div {
            font-family: pt-serif-pro,sans-serif;
            font-weight: 400;
            font-style: normal;
        }

        canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>

    <div class="container-sm py-5 text-center align-items-center  justify-content-center">
        <main>
            <h1 class="pb-4">Pagos Graduación Admin</h1>

            <!-- Loading spinner -->
            <div class="container align-items-center text-center" id="spinner">
                <strong>Cargando...</strong><br><br>
                <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
            </div>

            <div id="logged_in" style="display: none" class="table-responsive">
                <div id="show_email" class="pb-4"></div>

                <hr>
                <h3 class="mb-3">Registrar Pago</h3>
                <form class="mb-3" onsubmit="pagar()" action="javascript:void(0);">
                    <div class="mb-3 row">
                        <label for="email_pagador" class="col-sm-2 col-form-label">Email del Pagador</label>
                        <div class="col-sm-10">
                            <select class="form-select" aria-label="Email Pagador" id="email_pagador">
                                <option selected>Selecciona una opción</option>
                                <option value="alberto.ospino@csm.edu.mx">alberto.ospino@csm.edu.mx</option>
                                <option value="ana.aguilar@csm.edu.mx">ana.aguilar@csm.edu.mx</option>
                                <option value="andres.muedano@csm.edu.mx">andres.muedano@csm.edu.mx</option>
                                <option value="bianca.barcia@csm.edu.mx">bianca.barcia@csm.edu.mx</option>
                                <option value="carlos.carreon@csm.edu.mx">carlos.carreon@csm.edu.mx</option>
                                <option value="carlos.egry@csm.edu.mx">carlos.egry@csm.edu.mx</option>
                                <option value="camila.lopez@csm.edu.mx">camila.lopez@csm.edu.mx</option>
                                <option value="daniel.campa@csm.edu.mx">daniel.campa@csm.edu.mx</option>
                                <option value="dominique.olvera@csm.edu.mx">dominique.olvera@csm.edu.mx</option>
                                <option value="eduardo.giles@csm.edu.mx">eduardo.giles@csm.edu.mx</option>
                                <option value="emilia.christlieb@csm.edu.mx">emilia.christlieb@csm.edu.mx</option>
                                <option value="georgina.schiaffino@csm.edu.mx">georgina.schiaffino@csm.edu.mx</option>
                                <option value="gustavo.garfias@csm.edu.mx">gustavo.garfias@csm.edu.mx</option>
                                <option value="guillermo.bulnes@csm.edu.mx">guillermo.bulnes@csm.edu.mx</option>
                                <option value="hector.thomassiny@csm.edu.mx">hector.thomassiny@csm.edu.mx</option>
                                <option value="ian.saturno@csm.edu.mx">ian.saturno@csm.edu.mx</option>
                                <option value="iann.diaz@csm.edu.mx">iann.diaz@csm.edu.mx</option>
                                <option value="julian.gonzalez@csm.edu.mx">julian.gonzalez@csm.edu.mx</option>
                                <option value="joel.butzberger@csm.edu.mx">joel.butzberger@csm.edu.mx</option>
                                <option value="kebia.urdapilleta@csm.edu.mx">kebia.urdapilleta@csm.edu.mx</option>
                                <option value="konstanze.ponisch@csm.edu.mx">konstanze.ponisch@csm.edu.mx</option>
                                <option value="lucia.vega@csm.edu.mx">lucia.vega@csm.edu.mx</option>
                                <option value="luis.sarzo@csm.edu.mx">luis.sarzo@csm.edu.mx</option>
                                <option value="miguel.arenas@csm.edu.mx">miguel.arenas@csm.edu.mx</option>
                                <option value="paola.rodriguez@csm.edu.mx">paola.rodriguez@csm.edu.mx</option>
                                <option value="paulina.ruiz@csm.edu.mx">paulina.ruiz@csm.edu.mx</option>
                                <option value="regina.vazquez@csm.edu.mx">regina.vazquez@csm.edu.mx</option>
                                <option value="rene.ramirez@csm.edu.mx">rene.ramirez@csm.edu.mx</option>
                                <option value="sofia.ibarra@csm.edu.mx">sofia.ibarra@csm.edu.mx</option>
                                <option value="sofia.zamora@csm.edu.mx">sofia.zamora@csm.edu.mx</option>
                                <option value="victoria.aguilar@csm.edu.mx">victoria.aguilar@csm.edu.mx</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="fecha" class="col-sm-2 col-form-label">Fecha de Pago</label>
                        <div class="col-sm-10">
                            <input type="datetime-local" id="fecha"
                                   name="fecha" value="2023-01-12T19:30"
                                   min="2023-01-01T00:00" max="2024-01-01T00:00" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="pagador" class="col-sm-2 col-form-label">Folio Recibo</label>
                        <div class="col-sm-10">
                            <input type="text" id="folio" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="cant" class="col-sm-2 col-form-label"># Boletos Pagados</label>
                        <div class="col-sm-10">
                            <input type="number" id="cant" class="form-control" oninput="updateMonto()">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="monto" class="col-sm-2 col-form-label">Monto Pagado</label>
                        <div class="col-sm-10">
                            <input type="number" id="monto" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="pagador" class="col-sm-2 col-form-label">Pagador</label>
                        <div class="col-sm-10">
                            <input type="text" id="pagador" class="form-control">
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="receptor" class="col-sm-2 col-form-label">Receptor</label>
                        <div class="col-sm-10">
                            <select class="form-select" aria-label="Nombre Receptor" id="receptor">
                                <option selected>Gustavo Garfias</option>
                                <option>Lucía Vega</option>
                                <option>Georgina Schiaffino</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-sm">
                        <button type="submit" class="btn btn-primary">Registrar Pago</button>
                    </div>
                </form>
                <hr>
                <h3>Buscar Pagos</h3>
                <form class="mb-3" onsubmit="buscar()" action="javascript:void(0);">
                    <div class="mb-3 row">
                        <label for="search_email" class="col-sm-2 col-form-label">Email del Pagador</label>
                        <div class="col-sm-10">
                            <select class="form-select" aria-label="Email Pagador" id="search_email">
                                <option selected>Selecciona una opción</option>
                                <option value="alberto.ospino@csm.edu.mx">alberto.ospino@csm.edu.mx</option>
                                <option value="ana.aguilar@csm.edu.mx">ana.aguilar@csm.edu.mx</option>
                                <option value="andres.muedano@csm.edu.mx">andres.muedano@csm.edu.mx</option>
                                <option value="bianca.barcia@csm.edu.mx">bianca.barcia@csm.edu.mx</option>
                                <option value="carlos.carreon@csm.edu.mx">carlos.carreon@csm.edu.mx</option>
                                <option value="carlos.egry@csm.edu.mx">carlos.egry@csm.edu.mx</option>
                                <option value="camila.lopez@csm.edu.mx">camila.lopez@csm.edu.mx</option>
                                <option value="daniel.campa@csm.edu.mx">daniel.campa@csm.edu.mx</option>
                                <option value="dominique.olvera@csm.edu.mx">dominique.olvera@csm.edu.mx</option>
                                <option value="eduardo.giles@csm.edu.mx">eduardo.giles@csm.edu.mx</option>
                                <option value="emilia.christlieb@csm.edu.mx">emilia.christlieb@csm.edu.mx</option>
                                <option value="georgina.schiaffino@csm.edu.mx">georgina.schiaffino@csm.edu.mx</option>
                                <option value="gustavo.garfias@csm.edu.mx">gustavo.garfias@csm.edu.mx</option>
                                <option value="guillermo.bulnes@csm.edu.mx">guillermo.bulnes@csm.edu.mx</option>
                                <option value="hector.thomassiny@csm.edu.mx">hector.thomassiny@csm.edu.mx</option>
                                <option value="ian.saturno@csm.edu.mx">ian.saturno@csm.edu.mx</option>
                                <option value="iann.diaz@csm.edu.mx">iann.diaz@csm.edu.mx</option>
                                <option value="julian.gonzalez@csm.edu.mx">julian.gonzalez@csm.edu.mx</option>
                                <option value="joel.butzberger@csm.edu.mx">joel.butzberger@csm.edu.mx</option>
                                <option value="kebia.urdapilleta@csm.edu.mx">kebia.urdapilleta@csm.edu.mx</option>
                                <option value="konstanze.ponisch@csm.edu.mx">konstanze.ponisch@csm.edu.mx</option>
                                <option value="lucia.vega@csm.edu.mx">lucia.vega@csm.edu.mx</option>
                                <option value="luis.sarzo@csm.edu.mx">luis.sarzo@csm.edu.mx</option>
                                <option value="miguel.arenas@csm.edu.mx">miguel.arenas@csm.edu.mx</option>
                                <option value="paola.rodriguez@csm.edu.mx">paola.rodriguez@csm.edu.mx</option>
                                <option value="paulina.ruiz@csm.edu.mx">paulina.ruiz@csm.edu.mx</option>
                                <option value="regina.vazquez@csm.edu.mx">regina.vazquez@csm.edu.mx</option>
                                <option value="rene.ramirez@csm.edu.mx">rene.ramirez@csm.edu.mx</option>
                                <option value="sofia.ibarra@csm.edu.mx">sofia.ibarra@csm.edu.mx</option>
                                <option value="sofia.zamora@csm.edu.mx">sofia.zamora@csm.edu.mx</option>
                                <option value="victoria.aguilar@csm.edu.mx">victoria.aguilar@csm.edu.mx</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-sm">
                        <button type="submit" class="btn btn-primary">Buscar Pagos</button>
                    </div>
                </form>
                <div id="search_results"></div>
                <div class="table-responsive pb-4">
                    <table class="table table-hover table-sm">
                        <thead>
                        <tr>
                            <th>Fecha de Pago</th>
                            <th>Cantidad de Boletos Pagados</th>
                            <th>Monto Pagado</th>
                            <th>Pagado por</th>
                            <th>Recibido por</th>
                            <th>Folio</th>
                        </tr>
                        </thead>
                        <tbody id="tbody">
                        </tbody>
                        <tbody id="totales"></tbody>
                    </table>
                </div>
                <hr>

                <h3 class="pb-3">Todos los Pagos</h3>
                <button type="button" class="btn btn-primary" onclick="loadAll()">Cargar Todos los Pagos</button>
                <div class="table-responsive pb-4">
                    <table class="table table-hover table-sm">
                        <thead>
                        <tr>
                            <th>Fecha de Pago</th>
                            <th>Cantidad de Boletos Pagados</th>
                            <th>Monto Pagado</th>
                            <th>Pagado por</th>
                            <th>Recibido por</th>
                            <th>Folio</th>
                        </tr>
                        </thead>
                        <tbody id="body_all">
                        </tbody>
                    </table>
                </div>


                <hr>
                <!-- Cerrar sesión -->
                <div class="container">
                    <button type="button" class="btn btn-outline-danger mb-3" onclick="logout()">Cerrar Sesión</button>
                </div>
            </div>

            <div class="error" id="error_box"></div>

            <div class="container text-center align-items-center justify-content-center" id="login-form" style="display: none">
                <form onsubmit="login()" action="javascript:void(0);">
                    <div class="row">
                        <div class="col-5">
                            <input type="email" class="form-control" id="email" placeholder="Email">
                        </div>
                        <div class="col-5">
                            <input type="password" class="form-control" id="password" placeholder="Contraseña">
                        </div>
                        <div class="col-sm">
                            <button type="submit" class="btn btn-primary">Iniciar Sesión</button>
                        </div>
                    </div>
                </form>
                <div class="col-12" id="captcha_container"></div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('fecha').value = now.toISOString().slice(0,16);

            checkLogInStatus();
        });

        var email = "";

        var db = firebaseApp.firestore();

        function pagar() {


            let email_pagador = document.getElementById('email_pagador').value;
            let fecha = changeTimeZone(new Date(document.getElementById('fecha').value), 'America/Mexico_City');
            let cant = Number(document.getElementById('cant').value);
            let monto = Number(document.getElementById('monto').value);
            let pagador = document.getElementById('pagador').value;
            let receptor = document.getElementById('receptor').value;
            let folio = document.getElementById('folio').value;

            if (confirm(`Por favor confirma que los datos del pago sean correctos:\nPagador: ${email_pagador}\nCantidad: ${cant}\nMonto: ${monto}\nFecha y hora: ${fecha.toLocaleString()}\nFolio: ${folio}`)) {
                //console.log('confirmed')
                // Add a new document with a generated id.
                db.collection("pagos-grad").add({
                    email: email_pagador,
                    fecha: firebase.firestore.Timestamp.fromDate(fecha),
                    cant: cant,
                    monto: monto,
                    pagador: pagador,
                    receptor: receptor,
                    folio: folio
                })
                    .then((docRef) => {
                        console.log("Document written with ID: ", docRef.id);
                        alert('¡El pago fue registrado exitosamente!');

                        db.collection('pagos-grad').doc('counts').update({
                            boletos: firebase.firestore.FieldValue.increment(cant),
                            dinero: firebase.firestore.FieldValue.increment(monto),
                        });

                        emailjs.send("service_tcq84v5","template_xc78ags",{
                            to_name: pagador,
                            fecha: fecha.toLocaleString(),
                            cant: `${cant}`,
                            monto: `${format_currency(monto)}`,
                            to_email: email_pagador,
                        });

                        // Agregar pago a la lista de todos los pagos

                        let row = document.createElement('tr');

                        let fecha = document.createElement('td');
                        fecha.innerText = `${fecha.toLocaleDateString()}, ${fecha.toLocaleTimeString()}`;
                        let cant = document.createElement('td');
                        cant.innerText = cant;
                        let monto = document.createElement('td');
                        monto.innerText = format_currency(monto);
                        let pagador = document.createElement('td');
                        pagador.innerText = pagador;
                        let receptor = document.createElement('td');
                        receptor.innerText = receptor;
                        let folio = document.createElement('td');
                        folio.innerText = folio;

                        //paid += pago.cant;

                        row.append(fecha, cant, monto, pagador, receptor, folio);
                        document.getElementById('body_all').append(row);
                    })
                    .catch((error) => {
                        console.error("Error adding document: ", error);
                    });
            }
        }

        function buscar() {
            let search_email = document.getElementById('search_email').value;

            var paid = 0;

            document.getElementById('tbody').innerHTML = "";
            document.getElementById('totales').innerHTML = "";

            db.collection("pagos-grad").where("email", "==", search_email)
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        // doc.data() is never undefined for query doc snapshots
                        console.log(doc.id, " => ", doc.data());

                        let pago = doc.data();

                        let row = document.createElement('tr');

                        let fecha = document.createElement('td');
                        fecha.innerText = `${pago.fecha.toDate().toLocaleDateString()}, ${pago.fecha.toDate().toLocaleTimeString()}`;
                        let cant = document.createElement('td');
                        cant.innerText = pago.cant;
                        let monto = document.createElement('td');
                        monto.innerText = format_currency(pago.monto);
                        let pagador = document.createElement('td');
                        pagador.innerText = pago.pagador;
                        let receptor = document.createElement('td');
                        receptor.innerText = pago.receptor;
                        let folio = document.createElement('td');
                        folio.innerText = pago.folio;

                        paid += pago.cant;

                        row.append(fecha, cant, monto, pagador, receptor, folio);
                        document.getElementById('tbody').append(row);
                    });

                    let totals_row = document.createElement('tr');
                    let empty = document.createElement('th');
                    empty.innerText = "Total"
                    let cant_tot = document.createElement('th');
                    cant_tot.innerText = paid;
                    let monto_tot = document.createElement('th');
                    monto_tot.innerText = format_currency(paid * 1450);
                    totals_row.append(empty, cant_tot, monto_tot, document.createElement('th'), document.createElement('th'), document.createElement('th'));

                    document.getElementById('totales').append(totals_row);

                    db.collection("votos").where("email", "==", search_email)
                        .get()
                        .then((querySnapshot) => {
                            querySnapshot.forEach((doc) => {
                                // doc.data() is never undefined for query doc snapshots
                                console.log(doc.id, " => ", doc.data());
                                let voto = doc.data();

                                let boletos = voto.invitados_cena;

                                let name = capitalizeFirstLetter(search_email.split('@')[0].split('.')[0]);
                                let last_name = capitalizeFirstLetter(search_email.split('@')[0].split('.')[1]);

                                document.getElementById('search_results').innerHTML = `<b>${name} ${last_name} ha pagado ${paid} de ${boletos} boletos que se compremetió a adquirir.</b>`;
                            });
                        })
                        .catch((error) => {
                            console.log("Error getting documents: ", error);
                        });
                })
                .catch((error) => {
                    console.log("Error getting documents: ", error);
                });

        }

        function loadAll() {
            document.getElementById('body_all').innerHTML = "";

            db.collection("pagos-grad").orderBy('fecha')
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        // doc.data() is never undefined for query doc snapshots
                        console.log(doc.id, " => ", doc.data());

                        let pago = doc.data();

                        let row = document.createElement('tr');

                        let fecha = document.createElement('td');
                        fecha.innerText = `${pago.fecha.toDate().toLocaleDateString()}, ${pago.fecha.toDate().toLocaleTimeString()}`;
                        let cant = document.createElement('td');
                        cant.innerText = pago.cant;
                        let monto = document.createElement('td');
                        monto.innerText = format_currency(pago.monto);
                        let pagador = document.createElement('td');
                        pagador.innerText = pago.pagador;
                        let receptor = document.createElement('td');
                        receptor.innerText = pago.receptor;
                        let folio = document.createElement('td');
                        folio.innerText = pago.folio;

                        //paid += pago.cant;

                        row.append(fecha, cant, monto, pagador, receptor, folio);
                        document.getElementById('body_all').append(row);
                    });

                    /*
                    let totals_row = document.createElement('tr');
                    let empty = document.createElement('th');
                    empty.innerText = "Total"
                    let cant_tot = document.createElement('th');
                    cant_tot.innerText = paid;
                    let monto_tot = document.createElement('th');
                    monto_tot.innerText = format_currency(paid * 1450);
                    totals_row.append(empty, cant_tot, monto_tot, document.createElement('th'), document.createElement('th'), document.createElement('th'));

                    document.getElementById('totales').append(totals_row);

                    db.collection("votos").where("email", "==", search_email)
                        .get()
                        .then((querySnapshot) => {
                            querySnapshot.forEach((doc) => {
                                // doc.data() is never undefined for query doc snapshots
                                console.log(doc.id, " => ", doc.data());
                                let voto = doc.data();

                                let boletos = voto.invitados_cena;

                                let name = capitalizeFirstLetter(search_email.split('@')[0].split('.')[0]);
                                let last_name = capitalizeFirstLetter(search_email.split('@')[0].split('.')[1]);

                                document.getElementById('search_results').innerHTML = `<b>${name} ${last_name} ha pagado ${paid} de ${boletos} boletos que se compremetió a adquirir.</b>`;
                            });
                        })
                        .catch((error) => {
                            console.log("Error getting documents: ", error);
                        });
                     */
                })
                .catch((error) => {
                    console.log("Error getting documents: ", error);
                });
        }

        function capitalizeFirstLetter(str) {

            // converting first letter to uppercase
            const capitalized = str.charAt(0).toUpperCase() + str.slice(1);

            return capitalized;
        }

        function updateMonto() {
            let cant = Number(document.getElementById('cant').value);

            document.getElementById('monto').value = cant * 1450;
        }

        function loadData() {
            var db = firebaseApp.firestore();

            show();
        }

        function changeTimeZone(date, timeZone) {
            if (typeof date === 'string') {
                return new Date(
                    new Date(date).toLocaleString('en-US', {
                        timeZone,
                    }),
                );
            }

            return new Date(
                date.toLocaleString('en-US', {
                    timeZone,
                }),
            );
        }

        function format_currency(value) {
            //Currency formatter
            const options = { style: 'currency', currency: 'MXN' };
            const formatter = new Intl.NumberFormat('es-MX', options);

            return formatter.format(value);
        }

        function checkLogInStatus() {
            const auth = firebaseApp.auth();

            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in, see docs for a list of available properties
                    // https://firebase.google.com/docs/reference/js/firebase.User
                    var email1 = user.email;

                    document.getElementById("show_email").innerText = "Bienvenido, " + email1;

                    email = email1;

                    loadData();
                    //show();

                    // ...
                } else {
                    // User is signed out
                    hide();
                }
            });
        }

        function login() {
            var email = document.getElementById("email").value;
            var password = document.getElementById("password").value;

            const auth = firebaseApp.auth();

            /*
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    // Existing and future Auth states are now persisted in the current
                    // session only. Closing the window would clear any existing state even
                    // if a user forgets to sign out.
                    // ...
                    // New sign-in will be persisted with session persistence.
                    //return auth.signInWithEmailAndPassword(email, password);

                })
                .catch((error) => {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;

                    document.getElementById("error_box").innerText = errorMessage;
                });
             */

            var resolver;
            var verification_id_global;

            auth.signInWithEmailAndPassword(email, password)
                .then(function(userCredential) {
                    // User is not enrolled with a second factor and is successfully signed in.
                    // ...
                    checkLogInStatus();
                })
                .catch(function(error) {
                    if (error.code == 'auth/multi-factor-auth-required') {
                        resolver = error.resolver;
                        // Ask user which second factor to use.
                        console.log(resolver.hints);
                        if (resolver.hints[0].factorId ===
                            firebase.auth.PhoneMultiFactorGenerator.FACTOR_ID) {
                            var phoneInfoOptions = {
                                multiFactorHint: resolver.hints[0],
                                session: resolver.session
                            };
                            var phoneAuthProvider = new firebase.auth.PhoneAuthProvider();

                            const container = document.getElementById("captcha_container");
                            var recaptchaVerifier = new firebase.auth.RecaptchaVerifier(container);

                            // Send SMS verification code
                            return phoneAuthProvider.verifyPhoneNumber(phoneInfoOptions, recaptchaVerifier)
                                .then(async function (verificationId) {
                                    // Ask user for the SMS verification code.
                                    verification_id_global = verificationId;
                                    const field = document.createElement("div");
                                    field.innerHTML = `
                                    <form onsubmit="smsCodeEntered()" action="javascript:void(0);">
                                        <div class="row pt-5">
                                            <div class="col-4">
                                                <input type="number" class="form-control" id="smsVerCode" placeholder="Código de Verificación SMS">
                                            </div>
                                            <div class="col-2">
                                                <button type="submit" class="btn btn-primary">Verificar</button>
                                            </div>
                                        </div>
                                    </form>`;
                                    container.innerHTML = "";
                                    container.append(field);


                                    await until(_ => codeEntered == true);

                                    const verificationCode = document.getElementById("smsVerCode").value;
                                    var cred = firebase.auth.PhoneAuthProvider.credential(
                                        verificationId, verificationCode);
                                    var multiFactorAssertion =
                                        firebase.auth.PhoneMultiFactorGenerator.assertion(cred);
                                    // Complete sign-in.
                                    return resolver.resolveSignIn(multiFactorAssertion);
                                })
                                .then(function(userCredential) {
                                    // User successfully signed in with the second factor phone number.
                                    console.log(userCredential);
                                });
                        } else {
                            // Unsupported second factor.
                        }
                    } else if (error.code == 'auth/wrong-password') {
                        // Handle other errors such as wrong password.
                        alert("Contraseña incorrecta, intenta de nuevo.");
                    }
                });

            checkLogInStatus();
        }

        function show() {
            // successful login
            document.getElementById("login-form").style.display = "none";
            document.getElementById("logged_in").style.display = "initial";
            document.getElementById("error_box").style.display = "none";

            document.getElementById("email").value = "";
            document.getElementById("password").value = "";
            document.getElementById("error_box").innerText = "";

            document.getElementById("spinner").style.display = "none";
        }
        function hide() {
            // successful logout
            document.getElementById("login-form").style.display = "initial";
            document.getElementById("logged_in").style.display = "none";
            document.getElementById("error_box").style.display = "initial";
            document.getElementById("spinner").style.display = "none";
        }

        function logout() {
            firebase.auth().signOut();
            location.reload();
        }

        function restorePass() {
            firebaseApp.auth().sendPasswordResetEmail(email)
                .then(() => {
                    // Password reset email sent!
                    // ..
                    alert('Un correo electrónico con instrucciones para recuperar tu contraseña fue enviado en caso de que tu email sea correcto.');
                })
                .catch((error) => {
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // ..
                    alert(`No se pudo restablecer tu contraseña, por favor verifica que hayas escrito tu email correctamente.\n${errorMessage}`);
                });
        }
    </script>
</body>
</html>